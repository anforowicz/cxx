# Testing

This document tries to provide an outline of different kinds of tests
used by the `cxx` project.

## Errors from proc macro

In some situations, we want to verify that the `#[cxx::bridge]` macro reports
expected error messages when invoked by `rustc`.  Such verification is handled
by test cases underneath `tests/ui` directory and driven by
`tests/compiletest.rs`.  The test cases consist of a pair of files:

* `foo.rs` is the input
* `foo.stderr` is the expected output

## Errors from C++ compiler

In some situations, we want to verify that
the C++ code
generated by a successful invocation of the `cxxbridge-cmd` command
results in expected error messages
when compiled by a C++ compiler.
(Errors from unsuccessful invocations of the `cxxbridge-cmd` command
should have test coverage provided by the `tests/ui` test suite.)

TODO: Implement such verification (e.g.
https://github.com/dtolnay/cxx/commit/534627667 improves an error message for
`UniquePtr<ForwardDeclaredType>`, but this currently doesn't have a
corresponding regression test).

## End-to-end functionality

End-to-end functional tests are structured as follows:

* The code under test is contained underneath `tests/ffi` directory which
  contains:
    - Rust code under test - the `cxx-test-suite` crate
      (`lib.rs` and `module.rs`) with:
        - A few `#[cxx::bridge]` declarations
        - Rust types under test (e.g. `struct R`)
        - Rust functions and methods under test (e.g. `r_return_primitive`)
    - C/C++ code under test (`tests.h` and `tests.cc`)
        - C++ types under test (e.g. `class C`)
        - C++ functions and methods under test (e.g. `c_return_primitive`)
* The testcases can be found in:
    - Rust calling into C++: `tests/test.rs`
    - C++ calling into Rust: `tests/ffi/test.cc`.
      The tests are transitively, manually invoked from the
      `cxx_run_test` function in `tests/ffi/test.cc`
